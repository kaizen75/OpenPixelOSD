/* SPDX-License-Identifier: GPL-2.0-only */
/**
 * Copyright (C) 2025 Vitaliy N <vitaliy.nimych@gmail.com>
 */
#include <stdbool.h>
#include "main.h"
#include "video_gen.h"

#define INTERLACED_GEN 0

#define NTSC_LINE_FREQ 15734.2657f
#define PAL_LINE_FREQ 15625.f
#define GEN_TIMER_CLOCK_FREQ  (170000000)
#define PAL_HSYNC_TIME       (0.0000047f)

#define LINE_FREQ_NTSC ((GEN_TIMER_CLOCK_FREQ/NTSC_LINE_FREQ+0.5f)/2)
#define LINE_FREQ_PAL  ((GEN_TIMER_CLOCK_FREQ/PAL_LINE_FREQ+0.5f)/2)
#define SYNC  (PAL_HSYNC_TIME*GEN_TIMER_CLOCK_FREQ)
#define HSYNC ((SYNC/2))
#define LSYNC (SYNC*4.7f)

// Reverence timing, interlaced, progressive(non-interlaced) : https://martin.hinner.info/vga/pal.html
#if INTERLACED_GEN
// Blank PAL (interlaced) TODO: add NTSC
#define GEN_BLANK_PAL_LINES  (625*2) // 2 fields per line
const uint16_t blank_pal_signal[GEN_BLANK_PAL_LINES] =
	{
	LSYNC,LSYNC, // line 1
    LSYNC,LSYNC, // line 2
    LSYNC,HSYNC, // line 3
    HSYNC,HSYNC, // line 4
    HSYNC,HSYNC, // line 5

    //  Field 1
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 6-15
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 16-25
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 26-35
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 36-45
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 46-55
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 56-65
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 66-75
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 76-85
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 86-95
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 96-105
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 106-115
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 116-125
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 126-135
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 136-145
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 146-155
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 156-165
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 166-175
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 176-185
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 186-195
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 196-205
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 206-215
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 216-225
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 226-235
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 236-245
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 246-255
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 256-265
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 266-275
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 276-285
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 286-295
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 296-305
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0, // line 306-310
	HSYNC,HSYNC, // line 311
    HSYNC,HSYNC, // line 312
    HSYNC,LSYNC, // line 313

    LSYNC,LSYNC, // line 314
    LSYNC,LSYNC, // line 315
    HSYNC,HSYNC, // line 316
    HSYNC,HSYNC, // line 317
    //  Field 2
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 318-327
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 328-337
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 338-347
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 348-357
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 358-367
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 368-377
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 378-387
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 388-397
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 398-407
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 408-417
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 418-427
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 428-437
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 438-447
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 448-457
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 458-467
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 468-477
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 478-487
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 488-497
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 498-507
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 408-517
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 418-527
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 428-537
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 448-547
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 458-557
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 468-567
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 478-577
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 488-587
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 498-597
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 408-607
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 418-617
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0, // line 618-622

	HSYNC,HSYNC, // line 623
    HSYNC,HSYNC, // line 624
    HSYNC,HSYNC  // line 625
};
#else
// Blank PAL (non-interlaced) TODO: add NTSC
#define GEN_BLANK_PAL_LINES  (312*2) // 2 fields per line
volatile const uint16_t blank_pal_signal[GEN_BLANK_PAL_LINES] =
	{
    LSYNC,LSYNC, // line 1
    LSYNC,LSYNC, // line 2
    LSYNC,HSYNC, // line 3
    HSYNC,HSYNC, // line 4
    HSYNC,HSYNC, // line 5

    //  Field 1
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 6-15
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 16-25
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 26-35
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 36-45
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 46-55
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 56-65
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 66-75
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 76-85
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 86-95
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 96-105
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 106-115
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 116-125
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 126-135
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 136-145
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 146-155
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 156-165
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 166-175
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 176-185
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 186-195
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 196-205
	SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 206-215
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 216-225
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 226-235
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 236-245
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 246-255
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 256-265
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 266-275
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 276-285
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 286-295
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 296-305
    SYNC,0,SYNC,0, SYNC,0,SYNC,0, // line 306-309
    SYNC,0, // line 310 NOTE: reducing flicker on some monitors
	// HSYNC,HSYNC, // line 310
    HSYNC,HSYNC, // line 311
    HSYNC,HSYNC, // line 312

};
#endif

CCMRAM_BSS volatile bool video_gen_enabled = false;

EXEC_RAM void video_gen_start(void)
{
    if (video_gen_enabled == false) {
        LL_TIM_CC_EnableChannel(TIM17, LL_TIM_CHANNEL_CH1);
        LL_TIM_EnableAllOutputs(TIM17);
        LL_TIM_EnableCounter(TIM17);
        LL_TIM_EnableDMAReq_CC1(TIM17);

        LL_DMA_DisableChannel(DMA1, LL_DMA_CHANNEL_6);
        LL_DMA_SetMemoryAddress(DMA1, LL_DMA_CHANNEL_6, (uint32_t)blank_pal_signal);
        LL_DMA_SetPeriphAddress(DMA1, LL_DMA_CHANNEL_6, (uint32_t)&TIM17->CCR1);
        LL_DMA_SetDataLength(DMA1, LL_DMA_CHANNEL_6, GEN_BLANK_PAL_LINES);
        TIM17->ARR=LINE_FREQ_PAL;
        LL_DMA_EnableChannel(DMA1, LL_DMA_CHANNEL_6);

        LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1, DAC12BIT_FROM_MV(250));

        video_gen_enabled = true;
    }
}

EXEC_RAM void video_gen_stop(void)
{
    if (video_gen_enabled == true) {
        LL_DMA_DisableChannel(DMA1, LL_DMA_CHANNEL_6);
        LL_TIM_DisableCounter(TIM17);
        LL_TIM_DisableAllOutputs(TIM17);
        LL_DAC_ConvertData12RightAligned(DAC1, LL_DAC_CHANNEL_1, DAC12BIT_FROM_MV(300));
        video_gen_enabled = false;

    }
}
